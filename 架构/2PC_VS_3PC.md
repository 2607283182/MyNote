https://www.jianshu.com/p/e7d459eb1c85
https://www.zhihu.com/question/422691164
https://zhuanlan.zhihu.com/p/145928703
https://www.hollischuang.com/archives/681

## 个人理解
### 2PC流程
1.协调者向参与者发送 
你们preparedTransaction(准备事务)，并且把要执行的SQL发送把(到了MySql的Undo Redo),然后返回给我结果，YES 或者 NO
2.参与者发送，回馈给协调者YES ， NO
3.协调者收到所有人的回复，如果都是YES，就COMMIT，如果有NO，就ROLLBACK.
缺点：
1. 第二步中，参与者准备事务，和发送事务SQL效率太低，假如现在100个参与者，有一个人在准备事务就失败了，那它得等其他的99个参与者发送完事务SQL才能往下执行。（也就是所谓的同步阻塞问题）
2. 只有协调者知道当前参与者状态，参与者不知道，就算再来个协调者，也不知道该COMMIT或者ROLLBACK了。（单点故障）
3. 网络分区问题，如果协调者到了最后一个阶段，COMMIT了，但是有的COMMIT的通，有的COMMIT失败，咋办(数据不一致)
4. 参与者挂了，协调者傻傻的等自己设定的超时时间。
### 3PC流程
主要思想：参与者保留自己所处的状态，并且使用自己的超时时间。

执行步骤
1. 协调者让参与者们执行到预准备事务
2. 协调者让参与者执行到准备好事务
3. 执行事务。
解决了2PC
1. 把原来的 [准备事务]和 [Undo Redo] 这一步拆分为两步，并且自己设置超时时间，如果自己超时了，就回滚设置状态就完事了。
2. 再来个协调者，看这些参与者的状态，如果状态有中断的，就再发一遍rollback,如果有commit的，就再发遍commit,如果全处在preprepared的，就rollback,如果有处在preprepared和prepared的的，就全部同步到prepared，继续执行。
3. 在prepared设置一个延迟时间的commit,如果过了这么长时间还没有commit，就自己commit（参与者自己设置个超时时间，如果超时了协调者还没给返回，就默认commit） ,这样，协调者有的commit的通，就commit,commit不通，就算了，反正有个延迟commit后面接着。
4. 参与者挂了，自己超时了，自己rollback，然后把状态设一下就完事了。

### 3PC缺陷
第三步 默认commit，会出现错误。

首先参与者没有接到协调者的通知有可能整个事务还处在第二阶段（处在第三阶段是没有问题的），如下1,2,3,4个子任务组成的事务，当第二阶段协调者通知完3后去通知4，但是4返回no。此时协调者去通知1,2,3回滚但是由于网络问题都没有通知到（或部分没有通知到）。此时的执行结果就是不一致的。